image: node:lts

before_script:
  - npm install -g @apidevtools/swagger-cli
  - npm install -g @stoplight/spectral-cli
  - npm install -g anypoint-cli-v4
  - export ANYPOINT_CLIENT_ID=6fd1624df84648248a2d21d999e7bc60
  - export ANYPOINT_CLIENT_SECRET=d308968217D24B879db0e2d0e3794398
  - export ANYPOINT_ORG=a9a32236-77e1-4d8b-baaf-22ff5a53b7f1
  - export GROUP_ID=a9a32236-77e1-4d8b-baaf-22ff5a53b7f1
  #- export NODE_DEBUG=request,http,axios
  - apt-get install python-pip
  - pip install yq

stages:
  - deploy

build-job:       # This job runs in the deploy stage
  stage: deploy
  script:
    - MAIN_FILE=$(echo "$CI_PROJECT_NAME" | sed -e "s/-spec/.yaml/g") #get main file name in a variable
    - BUNDLE_FILE=$(echo "$CI_PROJECT_NAME" | sed -e "s/-spec/.json/g") #get bundle file name in a variable
    - MAIN_JSON_FILE=$(echo "$CI_PROJECT_NAME" | sed -e "s/-spec/.json/g") #get bundle file name in a variable
    - ASSET_NAME=$(echo "$CI_PROJECT_NAME" | sed -e "s/-spec//g") #get exchange asset name in a variable


    - swagger-cli bundle --dereference "$MAIN_FILE" > "$BUNDLE_FILE" #build oas 3 json bundle file
    - spectral lint $MAIN_FILE --ruleset ruleset/myruleset.yaml #check oas file with rules

    - API_VERSION=$(grep -A0 'version:' $MAIN_FILE | tail -n1 | awk '{ print $2}')
    - API_DESCRIPTION=$(grep -A0 'description:' $MAIN_FILE | tail -n1 | awk '{ print $2}')
    - echo "$API_DESCRIPTION"

    - MAIN_FILE_REQUEST=$(echo "{\"apiVersion\":\"v1\",\"mainFile\":\"$MAIN_JSON_FILE\"}") #build main file json body
    - FILE_REQUEST=$(echo "{\"oas.json\":\"$MAIN_JSON_FILE\"}") #build oas json body

    - anypoint-cli-v4 exchange:asset:upload $GROUP_ID/$ASSET_NAME/$API_VERSION --name $ASSET_NAME --description "OAS" --properties="$MAIN_FILE_REQUEST" --files="$FILE_REQUEST" 


   